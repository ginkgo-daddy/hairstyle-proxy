# 缓存清理功能实现总结

## 功能概述

为了管理Railway的500MB存储限制，已在Proxy Server中实现了完整的缓存清理和存储监控功能。

## 实现的功能

### 1. 存储空间监控
- **实时监控**：每30分钟检查一次存储使用情况
- **阈值设置**：
  - 400MB：触发自动清理
  - 450MB：发出警告
  - 500MB：存储限制
- **自动清理**：达到阈值时自动执行清理策略

### 2. 多层级清理策略

#### 临时文件清理
- 清理超过24小时的临时上传文件
- 位置：`/data/temp_uploads/`

#### Gemini预处理缓存清理
- **常规模式**：清理7天以上的缓存文件
- **激进模式**：清理3天以上的缓存文件
- 自动更新缓存索引文件
- 位置：`/data/gemini_processed_user/`, `/data/gemini_processed_hairstyle/`

#### 结果文件清理
- **常规模式**：清理3天以上的结果目录
- **激进模式**：清理1天以上的结果目录
- 位置：`/data/results_*/`

### 3. 管理员界面增强

#### 存储状态显示
- 实时显示存储使用情况和百分比
- 可视化进度条，根据使用率变色
- 详细的存储空间分解（临时文件、缓存、结果等）

#### 手动清理功能
- **常规清理**：删除过期文件，保持性能
- **深度清理**：更激进的清理策略，释放更多空间

### 4. API接口

#### 存储状态API
```
GET /api/admin/storage-status
```
返回详细的存储使用情况和分解信息。

#### 手动清理API
```
POST /api/admin/cleanup-cache
{
  "aggressive": false  // true为深度清理
}
```

## 清理策略详情

### 自动触发条件
1. **400MB阈值**：触发常规清理
2. **450MB阈值**：触发激进清理 + 警告

### 清理优先级
1. **临时文件**（最高优先级）- 立即清理超过24小时的文件
2. **过期结果文件** - 根据模式清理1-3天的文件
3. **Gemini缓存** - 根据模式清理3-7天的缓存

### 清理效果
- 临时文件：通常释放较少空间，但清理频繁
- 结果文件：可能释放大量空间（每个结果目录可能数十MB）
- Gemini缓存：中等空间释放，但影响后续处理性能

## 配置参数

```python
STORAGE_LIMIT_MB = 500      # Railway存储限制
CLEANUP_THRESHOLD_MB = 400  # 自动清理阈值
WARNING_THRESHOLD_MB = 450  # 警告阈值
```

## 监控日志

系统会输出详细的监控和清理日志：
```
存储监控: 当前使用 245.8MB / 500MB
🧹 触发自动清理: 当前 401.2MB >= 阈值 400MB
清理临时文件: 5个文件, 2.3MB
清理结果文件: 120个文件, 85.4MB
✅ 清理后存储: 313.5MB (释放了 87.7MB)
```

## 使用建议

1. **定期检查**：通过管理员界面定期检查存储状态
2. **预防性清理**：在接近阈值前手动执行清理
3. **监控日志**：关注服务器日志中的存储监控信息
4. **调整参数**：根据实际使用情况调整清理阈值

## 安全特性

- 所有清理操作都有详细日志记录
- 保留缓存索引文件的一致性
- 清理前会检查文件年龄，避免误删新文件
- 支持手动清理的确认机制

这个系统确保了在Railway的500MB限制内稳定运行，同时保持了良好的缓存性能。
